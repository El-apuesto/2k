<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Your Story | StoryFrame</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <custom-navbar></custom-navbar>
    
    <main class="flex-grow container mx-auto px-4 py-12">
        <div class="max-w-6xl mx-auto">
            <h1 class="text-4xl font-bold mb-8 text-center bg-gradient-to-r from-purple-500 to-pink-500 text-transparent bg-clip-text">Create Your Cinematic Story</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Story Creation Form -->
                <div class="bg-gray-800 rounded-xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold mb-6">Story Details</h2>
                    
                    <form id="story-form" class="space-y-6">
                        <div>
                            <label for="story-title" class="block text-sm font-medium mb-2">Story Title</label>
                            <input type="text" id="story-title" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Enter your story title" required>
                        </div>
                        
                        <div>
                            <label for="main-character" class="block text-sm font-medium mb-2">Main Character Description</label>
                            <textarea id="main-character" rows="3" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Describe your main character (age, appearance, clothing, personality)" required></textarea>
                            <p class="text-xs text-gray-400 mt-1">Be specific for consistent visual generation (e.g., "Father Michael, 40 year old thin priest, nervous expression, Paul Dano features, wearing black clerical shirt and white collar")</p>
                        </div>
                        
                        <div>
                            <label for="story-genre" class="block text-sm font-medium mb-2">Genre</label>
                            <select id="story-genre" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="cinematic">Cinematic</option>
                                <option value="fantasy">Fantasy</option>
                                <option value="sci-fi">Sci-Fi</option>
                                <option value="drama">Drama</option>
                                <option value="horror">Horror</option>
                                <option value="romance">Romance</option>
                                <option value="noir">Noir</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="story-scenes" class="block text-sm font-medium mb-2">Scene Descriptions</label>
                            <div id="scene-container" class="space-y-4">
                                <!-- Dynamic scene inputs will be added here -->
                            </div>
                            <button type="button" id="add-scene" class="mt-3 flex items-center text-purple-400 hover:text-purple-300">
                                <i data-feather="plus-circle" class="w-4 h-4 mr-2"></i> Add Another Scene
                            </button>
                        </div>
                        
                        <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity flex items-center justify-center">
                            <i data-feather="zap" class="w-5 h-5 mr-2"></i> Generate Story
                        </button>
                    </form>
                </div>
                
                <!-- Story Preview -->
                <div class="bg-gray-800 rounded-xl p-8 shadow-xl">
                    <h2 class="text-2xl font-bold mb-6">Story Preview</h2>
                    
                    <div id="story-preview" class="bg-gray-900 rounded-lg overflow-hidden h-96 flex items-center justify-center relative">
                        <div id="video-placeholder" class="text-center p-6">
                            <i data-feather="film" class="w-16 h-16 mx-auto text-gray-600 mb-4"></i>
                            <h3 class="text-xl font-medium mb-2">Your Story Will Appear Here</h3>
                            <p class="text-gray-400">Fill out the form and click "Generate Story" to see your cinematic story come to life.</p>
                        </div>
                        
                        <div id="video-player-container" class="hidden w-full h-full">
                            <div class="relative w-full h-full">
                                <div id="scene-display" class="w-full h-full bg-black">
                                    <!-- Generated scenes will appear here -->
                                </div>
                                
                                <!-- Player Controls -->
                                <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                                    <div class="flex items-center justify-center space-x-6">
                                        <button id="prev-btn" class="text-white hover:text-purple-300">
                                            <i data-feather="skip-back"></i>
                                        </button>
                                        <button id="play-pause-btn" class="bg-white bg-opacity-20 rounded-full p-3 hover:bg-opacity-30">
                                            <i data-feather="play"></i>
                                        </button>
                                        <button id="next-btn" class="text-white hover:text-purple-300">
                                            <i data-feather="skip-forward"></i>
                                        </button>
                                    </div>
                                    <div id="scene-counter" class="text-center text-sm mt-2 text-gray-300">
                                        Scene 1 of 0
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-colors flex items-center justify-center">
                                    <i data-feather="download" class="w-5 h-5 mr-2"></i> Download MP4
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <custom-footer></custom-footer>

    <script src="components/navbar.js"></script>
    <script src="components/footer.js"></script>
    <script src="script.js"></script>
    <script>
        feather.replace();
        
        // Add scene functionality
        let sceneCount = 1;
        const addSceneBtn = document.getElementById('add-scene');
        const sceneContainer = document.getElementById('scene-container');
        
        function addScene(initialValue = '') {
            const sceneId = `scene-${sceneCount}`;
            const sceneDiv = document.createElement('div');
            sceneDiv.className = 'scene-input-group';
            sceneDiv.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <label for="${sceneId}" class="text-sm font-medium">Scene ${sceneCount}</label>
                    <button type="button" class="text-red-400 hover:text-red-300 remove-scene" data-scene-id="${sceneId}">
                        <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>
                <textarea id="${sceneId}" rows="2" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Describe this scene in detail">${initialValue}</textarea>
                <div class="flex items-center mt-1 space-x-4">
                    <div class="flex items-center">
                        <input type="radio" id="${sceneId}-fade" name="${sceneId}-transition" value="fade" checked class="mr-2">
                        <label for="${sceneId}-fade" class="text-xs">Fade</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${sceneId}-slide" name="${sceneId}-transition" value="slide" class="mr-2">
                        <label for="${sceneId}-slide" class="text-xs">Slide</label>
                    </div>
                    <div class="flex items-center">
                        <input type="radio" id="${sceneId}-none" name="${sceneId}-transition" value="none" class="mr-2">
                        <label for="${sceneId}-none" class="text-xs">None</label>
                    </div>
                </div>
            `;
            sceneContainer.appendChild(sceneDiv);
            sceneCount++;
            feather.replace();
            
            // Add event listener for remove button
            sceneDiv.querySelector('.remove-scene').addEventListener('click', function() {
                sceneDiv.remove();
                updateSceneNumbers();
            });
        }
        
        function updateSceneNumbers() {
            const scenes = sceneContainer.querySelectorAll('.scene-input-group');
            scenes.forEach((scene, index) => {
                const label = scene.querySelector('label');
                label.textContent = `Scene ${index + 1}`;
            });
            sceneCount = scenes.length + 1;
        }
        
        addSceneBtn.addEventListener('click', () => addScene());
        
        // Add initial scene
        addScene();
        
        // Form submission with AI generation
        document.getElementById('story-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const videoPlaceholder = document.getElementById('video-placeholder');
            const videoPlayerContainer = document.getElementById('video-player-container');
            const sceneDisplay = document.getElementById('scene-display');
            
            // Get form values
            const title = document.getElementById('story-title').value;
            const character = document.getElementById('main-character').value;
            const genre = document.getElementById('story-genre').value;
            
            // Get all scene descriptions
            const sceneInputs = document.querySelectorAll('#scene-container textarea');
            const scenes = Array.from(sceneInputs)
                .map(input => input.value.trim())
                .filter(scene => scene.length > 0);
            
            if (scenes.length === 0) {
                alert('Please add at least one scene description!');
                return;
            }
            
            // Show loading state
            videoPlaceholder.innerHTML = `
                <div class="flex flex-col items-center justify-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-purple-500 mb-4"></div>
                    <h3 class="text-xl font-medium mb-2">Generating Your Story</h3>
                    <p class="text-gray-400 text-center max-w-md">Creating scene 1 of ${scenes.length}...</p>
                </div>
            `;
            
            try {
                sceneDisplay.innerHTML = '';
                
                // Generate each scene
                for (let i = 0; i < scenes.length; i++) {
                    // Update progress
                    videoPlaceholder.querySelector('p').textContent = 
                        `Creating scene ${i + 1} of ${scenes.length}...`;
                    
                    // Build detailed prompt
                    const prompt = `Cinematic ${genre} scene: ${scenes[i]}. Character: ${character}. Professional photography, movie still, high quality, 8k, dramatic lighting`;
                    
                    // Call Netlify Function
                    const response = await fetch('/.netlify/functions/generate-image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `Failed to generate scene ${i + 1}`);
                    }
                    
                    const data = await response.json();
                    
                    // Create scene element
                    const sceneDiv = document.createElement('div');
                    sceneDiv.className = `absolute inset-0 scene-transition opacity-0 transition-opacity duration-1000 ${i === 0 ? 'opacity-100' : ''}`;
                    sceneDiv.dataset.sceneIndex = i;
                    
                    const img = document.createElement('img');
                    img.src = data.image;
                    img.className = 'w-full h-full object-cover';
                    img.alt = `Scene ${i + 1}: ${scenes[i].substring(0, 30)}...`;
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-6';
                    
                    const text = document.createElement('p');
                    text.className = 'text-white text-lg';
                    text.textContent = scenes[i];
                    
                    overlay.appendChild(text);
                    sceneDiv.appendChild(img);
                    sceneDiv.appendChild(overlay);
                    sceneDisplay.appendChild(sceneDiv);
                }
                
                // Show player
                videoPlaceholder.classList.add('hidden');
                videoPlayerContainer.classList.remove('hidden');
                
                // Initialize player
                initVideoPlayer();
                document.getElementById('scene-counter').textContent = `Scene 1 of ${scenes.length}`;
                
            } catch (error) {
                console.error('Error generating story:', error);
                videoPlaceholder.innerHTML = `
                    <div class="text-center p-6">
                        <i data-feather="alert-circle" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                        <h3 class="text-xl font-medium mb-2">Generation Failed</h3>
                        <p class="text-gray-400 mb-4">${error.message}</p>
                        <button onclick="location.reload()" class="bg-purple-600 px-6 py-2 rounded-lg hover:bg-purple-700">Try Again</button>
                    </div>
                `;
                feather.replace();
            }
        });
    </script>
</body>
</html>